#include "public.h"

//sd filesystem
#include <SdFat.h>
static SdFatSdioEX sdEx;
static File file;
static File dirFile;

void __filesystem_listfiles() {
  // List files in root directory.
  if (!dirFile.open("/", O_READ)) {
    sdEx.errorHalt("open root failed");
  }
  uint16_t n = 0;
  const uint16_t nMax = 10;
  uint16_t dirIndex[nMax];
  while (n < nMax && file.openNext(&dirFile, O_READ)) {

    // Skip directories and hidden files.
    if (!file.isSubDir() && !file.isHidden()) {

      // Save dirIndex of file in directory.
      dirIndex[n] = file.dirIndex();

      // Print the file number and name.
      Serial.print(n++);
      Serial.write(' ');
      file.printName(&Serial);
      Serial.println();
    }
    file.close();
  }
  dirFile.close();
}

void __filesystem_setup() {
  //sd filesystem

  // Initialize the SD card
  if (!sdEx.begin()) {
    sdEx.initErrorHalt("SdFatSdioEX begin() failed");
  }
  // make sdEx the current volume.
  sdEx.chvol();

}
